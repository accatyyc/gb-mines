#include <gb/gb.h>
#include <gb/drawing.h>
#include "game.h"

#define GRID_WIDTH 20
#define GRID_HEIGHT 18

unsigned char tiles[] =
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00, // 0
	0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x1C,0x1C,0x04,0x04,0x04,0x04, // 1
	0x04,0x04,0x04,0x04,0x04,0x04,0x1F,0x1F,
	0x00,0x00,0x3C,0x3C,0x04,0x04,0x04,0x04, // 2
	0x3C,0x3C,0x20,0x20,0x20,0x20,0x3C,0x3C,
	0x00,0x00,0x3C,0x3C,0x04,0x04,0x04,0x04, // 3
	0x3C,0x3C,0x04,0x04,0x04,0x04,0x3C,0x3C,
	0x00,0x00,0x24,0x24,0x24,0x24,0x24,0x24, // 4
	0x3C,0x3C,0x04,0x04,0x04,0x04,0x04,0x04,
	0x00,0x00,0x3C,0x3C,0x20,0x20,0x20,0x20, // 5
	0x3C,0x3C,0x04,0x04,0x04,0x04,0x3C,0x3C,
	0x00,0x00,0x3C,0x3C,0x20,0x20,0x20,0x20, // 6
	0x3C,0x3C,0x24,0x24,0x24,0x24,0x3C,0x3C,
	0x00,0x00,0x3C,0x3C,0x04,0x04,0x04,0x04, // 7
	0x0E,0x0E,0x04,0x04,0x04,0x04,0x04,0x04,
	0x00,0x00,0x3C,0x3C,0x24,0x24,0x24,0x24, // 8
	0x3C,0x3C,0x24,0x24,0x24,0x24,0x3C,0x3C,
	0x00,0x00,0x00,0x7E,0x00,0x7E,0x00,0x7E, // Unopened
	0x00,0x7E,0x00,0x7E,0x00,0x7E,0x00,0x00,
	0x00,0x00,0x08,0x08,0x18,0x18,0x38,0x38, // Flagged
	0x18,0x18,0x08,0x08,0x08,0x08,0x00,0x00,
	0x00,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E, // Blacked
	0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00,0x00
};

unsigned char sprites[] =
{
	0xFF,0xFF,0x81,0x81,0x81,0x81,0x81,0x81, // Marker
	0x81,0x81,0xC1,0x81,0xA1,0xC1,0xFF,0xFF
};

enum tile {
	Zero = 0,
	One = 1,
	Two = 2,
	Three = 3,
	Four = 4,
	Five = 5,
	Six = 6,
	Seven = 7,
	Eight = 8,
	Unopened = 9,
	Flagged = 10,
	Blacked = 11
};

void set_tile(int x, int y, unsigned char tile)
{
	set_bkg_tiles(x, y, 1, 1, &tile);
}

void move_marker(int x, int y)
{
	move_sprite(0, (SCREENWIDTH / GRID_WIDTH) * (x+1), (SCREENHEIGHT / GRID_HEIGHT) * (y+2));
}

int wrap(int value, int max)
{
	if (value < 0) return max;
	if (value > max) return 0;
	return value;
}

void play_game()
{
	int marker_x = GRID_WIDTH / 2, marker_y = GRID_HEIGHT / 2;
	int x, y;
	char input;

	// Setup background
	set_bkg_data(0, 12, tiles);
	for (x = 0;x<GRID_WIDTH;x += 1)
	{
		for (y = 0;y < GRID_HEIGHT;y += 1)
		{
			set_tile(x, y, Unopened);
		}
	}
	SHOW_BKG;

	// Setup sprites
	set_sprite_data(0, 1, sprites);
	set_sprite_tile(0, 0);
	SHOW_SPRITES;
	SPRITES_8x8;

	while (1)
	{
		input = joypad();
		if (input&J_UP) marker_y = wrap(marker_y - 1,GRID_HEIGHT-1);
		if (input&J_DOWN) marker_y = wrap(marker_y + 1, GRID_HEIGHT - 1);
		if (input&J_LEFT) marker_x = wrap(marker_x - 1, GRID_WIDTH - 1);
		if (input&J_RIGHT) marker_x = wrap(marker_x + 1, GRID_WIDTH - 1);
		move_marker(marker_x, marker_y);
		delay(75);
	}
}